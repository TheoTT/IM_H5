!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):t.yim=r()}(this,function(){var I="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(t,r){return t(r={exports:{}},r.exports),r.exports}var r,h=t(function(t,r){t.exports=function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])};function e(t,r){function i(){this.constructor=t}n(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}var r=t;function t(){}t.mixin=function(t){var r=t.prototype||t;r.isWildEmitter=!0,r.on=function(t,r,i){this.callbacks=this.callbacks||{};var n=3===arguments.length,e=n?r:void 0,o=n?i:r;return o.t=e,(this.callbacks[t]=this.callbacks[t]||[]).push(o),this},r.once=function(r,t,i){var n=this,e=3===arguments.length,o=e?t:void 0,s=e?i:t;return this.on(r,o,function t(){n.off(r,t),s.apply(this,arguments)}),this},r.releaseGroup=function(t){var r,i,n,e;for(r in this.callbacks=this.callbacks||{},this.callbacks)for(i=0,n=(e=this.callbacks[r]).length;i<n;i++)e[i].t===t&&(e.splice(i,1),i--,n--);return this},r.off=function(t,r){this.callbacks=this.callbacks||{};var i,n=this.callbacks[t];return n&&(1===arguments.length?delete this.callbacks[t]:(i=n.indexOf(r),n.splice(i,1),0===n.length&&delete this.callbacks[t])),this},r.emit=function(t){this.callbacks=this.callbacks||{};var r,i,n,e=[].slice.call(arguments,1),o=this.callbacks[t],s=this.getWildcardCallbacks(t);if(o)for(r=0,i=(n=o.slice()).length;r<i&&n[r];++r)n[r].apply(this,e);if(s)for(i=s.length,r=0,i=(n=s.slice()).length;r<i&&n[r];++r)n[r].apply(this,[t].concat(e));return this},r.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var r,i,n=[];for(r in this.callbacks)i=r.split("*"),("*"===r||2===i.length&&t.slice(0,i[0].length)===i[0])&&(n=n.concat(this.callbacks[r]));return n}},t.mixin(t);var i,m,o=function(r){function t(){var t=r.call(this)||this;return t.i={appKey:"",userId:"",token:""},t}return e(t,r),t.prototype.set=function(t,r){this.i[t]=r,this.emit("change:"+t,t,r)},t.prototype.get=function(t){return this.i[t]},t}(r),s=function(n){function t(t,r){var i=n.call(this)||this;return i.n=t,i.r=r,i.e=!1,i.s=!1,i.o="",i.u="",i.h="",i.f=6,i.r.on("message:7",function(){i.r.close(),i.s=!1,i.emit("kickoff")}),i}return e(t,n),t.prototype.login=function(t,r,i){var n=this;return this.s?r!==this.u?(this.logout(),new Promise(function(t){setTimeout(function(){return t()},100)}).then(function(){return n.login(t,r,i)})):Promise.resolve():(this.e=!0,this.n.set("appKey",t),this.n.set("userId",r),this.n.set("token",i),this.o=t,this.u=r,this.h=i,this.emit("logging"),this.r.send(1,{appkey:t,userid:r+"",session:i+"",notify:1,base:{os_type:this.f,ip:"",port:0}}).then(function(){n.e=!1,n.s=!0,n.emit("login")}).catch(function(t){throw n.e=!1,n.s=!1,n.r.close(),n.emit("error:"+t.name,t),t}))},t.prototype.logout=function(){this.r.close(),this.s=!1,this.emit("logout")},t.prototype.isLogging=function(){return this.e},t.prototype.isLogged=function(){return this.s},t.prototype.doIfLogged=function(){var e=this;return new Promise(function(t,r){if(e.s)t();else{var i=setTimeout(function(){e.off("login",n);var t=new Error;t.name="NotLoginError",r(t)},1e4),n=function(){t(),clearTimeout(i)};e.once("login",n)}})},t.prototype.getMyUserId=function(){return this.u},t.prototype.reconnect=function(){return this.s=!1,this.login(this.o,this.u,this.h)},t}(r),u=function(n){function t(t,r){var i=n.call(this)||this;return i.n=t,i.r=r,i.c={},i.r.on("status:ended",function(){return i.clear()}),i}return e(t,n),t.prototype.joinRoom=function(r){var i=this;return r+="",this.c[r]||(this.c[r]=[this.n.get("userId")]),this.emit("joining:"+r,r),this.r.send(3,{roomid:r}).then(function(t){return i.emit("join:"+r,r),r}).catch(function(t){throw i.emit("join-error:"+t.name,t,r),delete i.c[r],t})},t.prototype.leaveRoom=function(r){var i=this;return r+="",this.r.send(4,{roomid:r}).then(function(){delete i.c[r],i.emit("leave:"+r,r)}).catch(function(t){throw i.emit("leave-error:"+t.name,t,r),t})},t.prototype.leaveAllRoom=function(){for(var t=[],r=0,i=Object.keys(this.c);r<i.length;r++){var n=i[r];t.push(this.leaveRoom(n))}return Promise.all(t).then(function(){})},t.prototype.clear=function(){for(var t=0,r=Object.keys(this.c);t<r.length;t++){var i=r[t];this.emit("leave:"+i,i)}this.c={}},t.prototype.doIfJoinedRoom=function(r){var i=this;return new Promise(function(t){r+="",i.inRoom(r)?t():i.once("join:"+r,function(){return t()})})},t.prototype.inRoom=function(t){return t+="",!!this.c[t]},t.prototype.getRoomIdList=function(){return Object.keys(this.c)},t.prototype.reconnect=function(){for(var r=this,t=function(t){i.r.send(4,{roomid:t}).then(function(){return r.r.send(3,{roomid:t})})},i=this,n=0,e=this.getRoomIdList();n<e.length;n++)t(e[n])},t}(r),h="disconnected",c="connected",f="reconnecting",a="ended",d={0:"OK",20001:"NotLoginError",20002:"InvalidParamError",20003:"InvalidLoginError",20004:"UsernameOrTokenError",20005:"LoginTimeoutError",20006:"ServiceOverloadError",20007:"MessageTooLongError"},v=function(i){function t(t){var r=i.call(this)||this;return r.n=t,r.a=1,r.f=6,r.v=null,r.l="wss://webrtctest.youme.im",r.d=h,r.w=[],r.g={},r.m={},r.y={},r.p=!1,r.b=[],r.A=[],r.j=1530625445318,r.T=0,r}return e(t,i),t.prototype.init=function(t){return t||(r=this.n.get("appKey"),t=r?"wss://"+r.substr(r.length-8).toLowerCase()+".h5.youme.im:443":""),t&&(this.l=t,this.P(),this.k("connecting")),this;var r},t.prototype.send=function(i,t){var n=this;if(this.d!==h&&this.d!==a||(this.init(),this.d!==h&&this.d!==a))return this.j++,t.base=t.base||{},t.base=Object.assign(t.base,{msgtype:i,seq:this.j+"",version:this.a,os_type:this.f}),this.w.push(t),this.I(),this.T&&clearTimeout(this.T),this.T=setTimeout(function(){return n.O()},6e4),new Promise(function(t,r){n.g[n.j]=t,n.m[n.j]=r,n.y[i]=n.j});var r=new Error;return r.name="NotLoginError",Promise.reject(r)},t.prototype.getStatus=function(){return this.d},t.prototype.close=function(){this.k(a),this.v&&(this.v.close(),this.v=null),this.w=[],this.g={},this.j=0,this.T&&(clearTimeout(this.T),this.T=0)},t.prototype.checkNetwork=function(){var i=this;return new Promise(function(t,r){i.b.push(t),i.A.push(r),i.p||i.O()})},t.prototype.P=function(){this.v&&this.v.close(),this.v=new WebSocket(this.l),this.B()},t.prototype.C=function(){var t=this;if(this.d!==a){if(this.d!==f){for(var r in this.m)this.m.hasOwnProperty(r)&&this.m[r](new DOMException("Socket was closed.","NetworkError"));this.g={},this.m={},this.k(f)}this.v=null,setTimeout(function(){t.d===f&&t.P()},1e3)}this.T&&(clearTimeout(this.T),this.T=0)},t.prototype.B=function(){var u=this;this.v&&(this.v.addEventListener("open",function(){u.k(c),u.emit("ready"),u.I()}),this.v.addEventListener("error",function(t){u.emit("error",t)}),this.v.addEventListener("close",function(){u.C()}),this.v.addEventListener("message",function(t){var r=JSON.parse(t.data),i=r.ret,n=r.base,e=n.msgtype,o=n.seq;if(o||(o=u.y[e]),o&&u.g[o]){if(i&&"0"!==i){var s=new Error;s.name=d[i]||"Error-"+i,u.m[o](s)}else u.g[o](r);delete u.g[o],delete u.m[o]}u.emit("message:"+e,r)}))},t.prototype.k=function(t){this.d!==t&&(this.d=t,this.emit("status:"+t,t))},t.prototype.I=function(){if(this.d===c&&this.v){for(var t=0,r=this.w;t<r.length;t++){var i=r[t];this.v.send(JSON.stringify(i));var n=i.base;this.emit("send:"+n.msgtype,i)}this.w=[]}},t.prototype.O=function(){var t=this;if(!this.p){this.p=!0;var r=setTimeout(function(){t.U(!1),t.v&&t.v.close(),t.C()},1e4);this.send(0,{}).then(function(){clearTimeout(r),t.U(!0)}).catch(function(){clearTimeout(r),t.U(!1)})}},t.prototype.U=function(t){if(t)for(var r=0,i=this.b;r<i.length;r++){var n=i[r];n&&n()}else for(var e=0,o=this.A;e<o.length;e++){var s=o[e];s&&s()}this.b=[],this.A=[],this.p=!1},t}(r),p="undefined"!=typeof window?window:void 0!==I?I:"undefined"!=typeof self?self:{},l=(m=i={exports:{}},function(){var c="input is invalid type",t="object"==typeof window,r=t?window:{};r.JS_MD5_NO_WINDOW&&(t=!1);var i=!t&&"object"==typeof self,s=!r.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;s?r=p:i&&(r=self);var n,e=!r.JS_MD5_NO_COMMON_JS&&m.exports,f=!r.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,o="0123456789abcdef".split(""),u=[128,32768,8388608,-2147483648],a=[0,8,16,24],h=["hex","array","digest","buffer","arrayBuffer","base64"],d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),v=[];if(f){var l=new ArrayBuffer(68);n=new Uint8Array(l),v=new Uint32Array(l)}!r.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),!f||!r.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(t){return"object"==typeof t&&t.buffer&&t.buffer.constructor===ArrayBuffer});var E=function(r){return function(t){return new g(!0).update(t)[r]()}};function g(t){if(t)v[0]=v[16]=v[1]=v[2]=v[3]=v[4]=v[5]=v[6]=v[7]=v[8]=v[9]=v[10]=v[11]=v[12]=v[13]=v[14]=v[15]=0,this.blocks=v,this.buffer8=n;else if(f){var r=new ArrayBuffer(68);this.buffer8=new Uint8Array(r),this.blocks=new Uint32Array(r)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}g.prototype.update=function(t){if(!this.finalized){var r,i=typeof t;if("string"!==i){if("object"!==i)throw c;if(null===t)throw c;if(f&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||f&&ArrayBuffer.isView(t)))throw c;r=!0}for(var n,e,o=0,s=t.length,u=this.blocks,h=this.buffer8;o<s;){if(this.hashed&&(this.hashed=!1,u[0]=u[16],u[16]=u[1]=u[2]=u[3]=u[4]=u[5]=u[6]=u[7]=u[8]=u[9]=u[10]=u[11]=u[12]=u[13]=u[14]=u[15]=0),r)if(f)for(e=this.start;o<s&&e<64;++o)h[e++]=t[o];else for(e=this.start;o<s&&e<64;++o)u[e>>2]|=t[o]<<a[3&e++];else if(f)for(e=this.start;o<s&&e<64;++o)(n=t.charCodeAt(o))<128?h[e++]=n:(n<2048?h[e++]=192|n>>6:(n<55296||57344<=n?h[e++]=224|n>>12:(n=65536+((1023&n)<<10|1023&t.charCodeAt(++o)),h[e++]=240|n>>18,h[e++]=128|n>>12&63),h[e++]=128|n>>6&63),h[e++]=128|63&n);else for(e=this.start;o<s&&e<64;++o)(n=t.charCodeAt(o))<128?u[e>>2]|=n<<a[3&e++]:(n<2048?u[e>>2]|=(192|n>>6)<<a[3&e++]:(n<55296||57344<=n?u[e>>2]|=(224|n>>12)<<a[3&e++]:(n=65536+((1023&n)<<10|1023&t.charCodeAt(++o)),u[e>>2]|=(240|n>>18)<<a[3&e++],u[e>>2]|=(128|n>>12&63)<<a[3&e++]),u[e>>2]|=(128|n>>6&63)<<a[3&e++]),u[e>>2]|=(128|63&n)<<a[3&e++]);this.lastByteIndex=e,this.bytes+=e-this.start,64<=e?(this.start=e-64,this.hash(),this.hashed=!0):this.start=e}return 4294967295<this.bytes&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},g.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,r=this.lastByteIndex;t[r>>2]|=u[3&r],56<=r&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},g.prototype.hash=function(){var t,r,i,n,e,o,s=this.blocks;this.first?r=((r=((t=((t=s[0]-680876937)<<7|t>>>25)-271733879<<0)^(i=((i=(-271733879^(n=((n=(-1732584194^2004318071&t)+s[1]-117830708)<<12|n>>>20)+t<<0)&(-271733879^t))+s[2]-1126478375)<<17|i>>>15)+n<<0)&(n^t))+s[3]-1316259209)<<22|r>>>10)+i<<0:(t=this.h0,r=this.h1,i=this.h2,r=((r+=((t=((t+=((n=this.h3)^r&(i^n))+s[0]-680876936)<<7|t>>>25)+r<<0)^(i=((i+=(r^(n=((n+=(i^t&(r^i))+s[1]-389564586)<<12|n>>>20)+t<<0)&(t^r))+s[2]+606105819)<<17|i>>>15)+n<<0)&(n^t))+s[3]-1044525330)<<22|r>>>10)+i<<0),r=((r+=((t=((t+=(n^r&(i^n))+s[4]-176418897)<<7|t>>>25)+r<<0)^(i=((i+=(r^(n=((n+=(i^t&(r^i))+s[5]+1200080426)<<12|n>>>20)+t<<0)&(t^r))+s[6]-1473231341)<<17|i>>>15)+n<<0)&(n^t))+s[7]-45705983)<<22|r>>>10)+i<<0,r=((r+=((t=((t+=(n^r&(i^n))+s[8]+1770035416)<<7|t>>>25)+r<<0)^(i=((i+=(r^(n=((n+=(i^t&(r^i))+s[9]-1958414417)<<12|n>>>20)+t<<0)&(t^r))+s[10]-42063)<<17|i>>>15)+n<<0)&(n^t))+s[11]-1990404162)<<22|r>>>10)+i<<0,r=((r+=((t=((t+=(n^r&(i^n))+s[12]+1804603682)<<7|t>>>25)+r<<0)^(i=((i+=(r^(n=((n+=(i^t&(r^i))+s[13]-40341101)<<12|n>>>20)+t<<0)&(t^r))+s[14]-1502002290)<<17|i>>>15)+n<<0)&(n^t))+s[15]+1236535329)<<22|r>>>10)+i<<0,r=((r+=((n=((n+=(r^i&((t=((t+=(i^n&(r^i))+s[1]-165796510)<<5|t>>>27)+r<<0)^r))+s[6]-1069501632)<<9|n>>>23)+t<<0)^t&((i=((i+=(t^r&(n^t))+s[11]+643717713)<<14|i>>>18)+n<<0)^n))+s[0]-373897302)<<20|r>>>12)+i<<0,r=((r+=((n=((n+=(r^i&((t=((t+=(i^n&(r^i))+s[5]-701558691)<<5|t>>>27)+r<<0)^r))+s[10]+38016083)<<9|n>>>23)+t<<0)^t&((i=((i+=(t^r&(n^t))+s[15]-660478335)<<14|i>>>18)+n<<0)^n))+s[4]-405537848)<<20|r>>>12)+i<<0,r=((r+=((n=((n+=(r^i&((t=((t+=(i^n&(r^i))+s[9]+568446438)<<5|t>>>27)+r<<0)^r))+s[14]-1019803690)<<9|n>>>23)+t<<0)^t&((i=((i+=(t^r&(n^t))+s[3]-187363961)<<14|i>>>18)+n<<0)^n))+s[8]+1163531501)<<20|r>>>12)+i<<0,r=((r+=((n=((n+=(r^i&((t=((t+=(i^n&(r^i))+s[13]-1444681467)<<5|t>>>27)+r<<0)^r))+s[2]-51403784)<<9|n>>>23)+t<<0)^t&((i=((i+=(t^r&(n^t))+s[7]+1735328473)<<14|i>>>18)+n<<0)^n))+s[12]-1926607734)<<20|r>>>12)+i<<0,r=((r+=((o=(n=((n+=((e=r^i)^(t=((t+=(e^n)+s[5]-378558)<<4|t>>>28)+r<<0))+s[8]-2022574463)<<11|n>>>21)+t<<0)^t)^(i=((i+=(o^r)+s[11]+1839030562)<<16|i>>>16)+n<<0))+s[14]-35309556)<<23|r>>>9)+i<<0,r=((r+=((o=(n=((n+=((e=r^i)^(t=((t+=(e^n)+s[1]-1530992060)<<4|t>>>28)+r<<0))+s[4]+1272893353)<<11|n>>>21)+t<<0)^t)^(i=((i+=(o^r)+s[7]-155497632)<<16|i>>>16)+n<<0))+s[10]-1094730640)<<23|r>>>9)+i<<0,r=((r+=((o=(n=((n+=((e=r^i)^(t=((t+=(e^n)+s[13]+681279174)<<4|t>>>28)+r<<0))+s[0]-358537222)<<11|n>>>21)+t<<0)^t)^(i=((i+=(o^r)+s[3]-722521979)<<16|i>>>16)+n<<0))+s[6]+76029189)<<23|r>>>9)+i<<0,r=((r+=((o=(n=((n+=((e=r^i)^(t=((t+=(e^n)+s[9]-640364487)<<4|t>>>28)+r<<0))+s[12]-421815835)<<11|n>>>21)+t<<0)^t)^(i=((i+=(o^r)+s[15]+530742520)<<16|i>>>16)+n<<0))+s[2]-995338651)<<23|r>>>9)+i<<0,r=((r+=((n=((n+=(r^((t=((t+=(i^(r|~n))+s[0]-198630844)<<6|t>>>26)+r<<0)|~i))+s[7]+1126891415)<<10|n>>>22)+t<<0)^((i=((i+=(t^(n|~r))+s[14]-1416354905)<<15|i>>>17)+n<<0)|~t))+s[5]-57434055)<<21|r>>>11)+i<<0,r=((r+=((n=((n+=(r^((t=((t+=(i^(r|~n))+s[12]+1700485571)<<6|t>>>26)+r<<0)|~i))+s[3]-1894986606)<<10|n>>>22)+t<<0)^((i=((i+=(t^(n|~r))+s[10]-1051523)<<15|i>>>17)+n<<0)|~t))+s[1]-2054922799)<<21|r>>>11)+i<<0,r=((r+=((n=((n+=(r^((t=((t+=(i^(r|~n))+s[8]+1873313359)<<6|t>>>26)+r<<0)|~i))+s[15]-30611744)<<10|n>>>22)+t<<0)^((i=((i+=(t^(n|~r))+s[6]-1560198380)<<15|i>>>17)+n<<0)|~t))+s[13]+1309151649)<<21|r>>>11)+i<<0,r=((r+=((n=((n+=(r^((t=((t+=(i^(r|~n))+s[4]-145523070)<<6|t>>>26)+r<<0)|~i))+s[11]-1120210379)<<10|n>>>22)+t<<0)^((i=((i+=(t^(n|~r))+s[2]+718787259)<<15|i>>>17)+n<<0)|~t))+s[9]-343485551)<<21|r>>>11)+i<<0,this.first?(this.h0=t+1732584193<<0,this.h1=r-271733879<<0,this.h2=i-1732584194<<0,this.h3=n+271733878<<0,this.first=!1):(this.h0=this.h0+t<<0,this.h1=this.h1+r<<0,this.h2=this.h2+i<<0,this.h3=this.h3+n<<0)},g.prototype.toString=g.prototype.hex=function(){this.finalize();var t=this.h0,r=this.h1,i=this.h2,n=this.h3;return o[t>>4&15]+o[15&t]+o[t>>12&15]+o[t>>8&15]+o[t>>20&15]+o[t>>16&15]+o[t>>28&15]+o[t>>24&15]+o[r>>4&15]+o[15&r]+o[r>>12&15]+o[r>>8&15]+o[r>>20&15]+o[r>>16&15]+o[r>>28&15]+o[r>>24&15]+o[i>>4&15]+o[15&i]+o[i>>12&15]+o[i>>8&15]+o[i>>20&15]+o[i>>16&15]+o[i>>28&15]+o[i>>24&15]+o[n>>4&15]+o[15&n]+o[n>>12&15]+o[n>>8&15]+o[n>>20&15]+o[n>>16&15]+o[n>>28&15]+o[n>>24&15]},g.prototype.array=g.prototype.digest=function(){this.finalize();var t=this.h0,r=this.h1,i=this.h2,n=this.h3;return[255&t,t>>8&255,t>>16&255,t>>24&255,255&r,r>>8&255,r>>16&255,r>>24&255,255&i,i>>8&255,i>>16&255,i>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255]},g.prototype.buffer=g.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),r=new Uint32Array(t);return r[0]=this.h0,r[1]=this.h1,r[2]=this.h2,r[3]=this.h3,t},g.prototype.base64=function(){for(var t,r,i,n="",e=this.array(),o=0;o<15;)t=e[o++],r=e[o++],i=e[o++],n+=d[t>>>2]+d[63&(t<<4|r>>>4)]+d[63&(r<<2|i>>>6)]+d[63&i];return t=e[o],n+=d[t>>>2]+d[t<<4&63]+"=="};var w=function(){var r,i,n,e=E("hex");s&&(r=e,i=[eval][0]("require('crypto')"),n=[eval][0]("require('buffer').Buffer"),e=function(t){if("string"==typeof t)return i.createHash("md5").update(t,"utf8").digest("hex");if(null==t)throw c;return t.constructor===ArrayBuffer&&(t=new Uint8Array(t)),Array.isArray(t)||ArrayBuffer.isView(t)||t.constructor===n?i.createHash("md5").update(new n(t)).digest("hex"):r(t)}),e.create=function(){return new g},e.update=function(t){return e.create().update(t)};for(var t=0;t<h.length;++t){var o=h[t];e[o]=E(o)}return e}();e?m.exports=w:r.md5=w}(),i.exports),E=(l.hex,l.array,l.digest,l.arrayBuffer,l.buffer,l.create),g=(l.update,l.base64,function(t){function f(){var r=null!==t&&t.apply(this,arguments)||this;return r.__isReady=!1,r.__isCanceled=!1,r.__reqUpTk=null,r.__reqWXTk=null,r.__onReadyQueue=[],r.__onCancelQueue=[],r.__onSetUpTkFn=[],r.__onSetWXTkFn=[],r.__content="",r.typeId=0,r.__controls={initWithContent:function(t){return r.initWithContent(t).then(function(){return r.setContent(t)})},getContent:function(){return r.getContent()},getTypeId:function(){return r.getTypeId()},getType:function(){return r.getType()},onRequestUploadToken:function(t){return r.__onReqUpTk(t)},onRequestWechatToken:function(t){return r.__onReqWXTk(t)},waitForContent:function(){return r.__waitForContent()}},r}return e(f,t),f.prototype.setContent=function(t){this.__content="string"==typeof t?t:JSON.stringify(t),this.__isReady=!0;for(var r=0,i=this.__onReadyQueue;r<i.length;r++)(0,i[r])(this.__content);this.__onReadyQueue=[]},f.prototype.setCanceled=function(){this.__isCanceled=!0;for(var t=0,r=this.__onCancelQueue;t<r.length;t++){var i=r[t],n=new Error("Message Canceled.");n.name="CanceledError",i(n)}this.__onCancelQueue=[]},f.prototype.uploadFile=function(h){var c=this;return new Promise(function(o,s){var e,u=new FileReader;u.onload=function(){if(!(e=u.result)){var t=new Error;return t.name="UploadFileError",s(t)}var r=E();r.update(e);var i=r.hex(),n=function(i){var n=new XMLHttpRequest;n.ontimeout=function(t){s(t)},n.onerror=function(t){s(t)},n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){var t=i.downloadUrl,r=t.indexOf(":");-1<r&&r<7&&(t=t.substr(r+1)),o(t)}};var t=i.uploadUrl,r=t.indexOf(":");for(var e in-1<r&&r<7&&(t=t.substr(r+1)),n.open("PUT",t,!0),n.timeout=6e4,i.headers)"host"!==e&&i.headers.hasOwnProperty(e)&&n.setRequestHeader(e,i.headers[e]);n.send(h)};c.__reqUpTk?c.__reqUpTk(h.size,i,i,h.type.split("/")[1]).then(n).catch(function(t){return s(t)}):f.__gControls.reqUpTk?f.__gControls.reqUpTk(h.size,i,i,h.type.split("/")[1]).then(n).catch(function(t){return s(t)}):new Promise(function(t){c.__onSetUpTkFn.push(t)}).then(function(){c.__reqUpTk(h.size,i,i,h.type.split("/")[1]).then(n).catch(function(t){return s(t)})})},u.readAsArrayBuffer(h)})},f.prototype.requestWechatToken=function(){var r=this;return this.__reqWXTk?this.__reqWXTk():f.__gControls.reqWXTk?f.__gControls.reqWXTk():new Promise(function(t){r.__onSetWXTkFn.push(t)}).then(function(){return r.__reqWXTk()})},f.prototype.isReady=function(){return this.__isReady},f.prototype.isCanceled=function(){return this.__isCanceled},f.prototype.onReady=function(t,r){if(this.__isReady)return t();this.__isCanceled?r&&r():this.__waitForContent().then(function(){t()}).catch(function(t){"CanceledError"===t.name&&r&&r()})},f.prototype.getContent=function(){var t;if(this.__isCanceled)throw(t=new Error("Message Canceled.")).name="CanceledError",t;if(!this.__isReady)throw(t=new Error("Content is not ready yet.")).name="ContentNotReadyError",t;return this.__content},f.prototype.getTypeId=function(){return this.typeId},f.prototype.getType=function(){return this.typeName},f.prototype.__onReqUpTk=function(t){this.__reqUpTk=t;for(var r=0,i=this.__onSetUpTkFn;r<i.length;r++)(0,i[r])();this.__onSetUpTkFn=[]},f.prototype.__onReqWXTk=function(t){this.__reqWXTk=t;for(var r=0,i=this.__onSetWXTkFn;r<i.length;r++)(0,i[r])();this.__onSetWXTkFn=[]},f.prototype.__waitForContent=function(){var i=this;if(this.__isReady)return Promise.resolve(this.__content);if(this.__isCanceled){var t=new Error("Message Canceled.");return t.name="CanceledError",Promise.reject(t)}return new Promise(function(t,r){i.__onReadyQueue.push(t),i.__onCancelQueue.push(r)})},f.__gControls={},f}(r)),w=function(n){function o(t,r){var i=n.call(this)||this;return i.n=t,i.r=r,i.x={},i.M={},i.N=new Set,i._={},i.L={},i.S="",i.q=new Date(0),i.r.on("message:9",function(t){t&&"object"==typeof t.args&&i.r.send(10,{msgid:"0"}).then(function(t){i.D(t)})}),g.__gControls.reqUpTk=i.F.bind(i),g.__gControls.reqWXTk=i.R.bind(i),i}return e(o,n),o.prototype.registerMessageType=function(t){var r=new t,i=r.__controls.getTypeId(),n=r.__controls.getType();0===i&&"text"!==n?this.L[n]=t:this._[i]=t},o.prototype.sendToRoom=function(i,n){var e=this;return i+="",this.K(n).then(function(r){var t=o.J(i,"group",r);return e.W(t).then(function(t){var r=e.z(i,"group",t.svr_msgid,n);return e.H(r),e.emit("send:group:"+i,r),r}).catch(function(t){throw e.emit("send-failed:"+t.name+":group:"+i+":"+t.name,r,t),t})})},o.prototype.sendToUser=function(i,n){var e=this;return this.K(n).then(function(r){var t=o.J(i,"user",r);return e.W(t).then(function(t){var r=e.z(i,"user",t.svr_msgid,n);return e.H(r),e.emit("send:user:"+i,r),r}).catch(function(t){throw e.emit("send-failed:"+t.name+":user:"+i,r,t),t})})},o.prototype.requestHistoryMessage=function(t,r,i,n){var s=this;return this.r.send(11,{interlocutor:t,min_msgid:r,max_msgid:i,day_interval:n}).then(function(t){for(var r=[],i=0,n=t.msg_list;i<n.length;i++){var e=n[i],o=s.X(e);r.push(o)}return r})},o.prototype.clear=function(){this.x={},this.M={},this.N.clear()},o.prototype.D=function(t){for(var e=this,r=t.msg_list,i=function(t){var r=o.X(t),i=r.withPeer,n=r.chatType;o.H(r)&&o.K(r.message).then(function(){e.emit("receive:"+n+":"+i,r)})},o=this,n=0,s=r;n<s.length;n++)i(s[n])},o.prototype.X=function(t){var r,i=this,n=t.sender,e=t.receiver,o=t.sender===this.n.get("userId");switch(t.chattype){case 1:default:r="user";break;case 2:r="group"}var s,u=new Date(1e3*t.timespan),h=t.msgtype,c=t.content;if(0===h){var f=c.match(/^(.+?)!/),a=f?f[1]:null;a?(c=c.replace(/^(.+?)!/,""),s=this.L[a]):s=this._[0]}else s=this._[h];if(!s){var d=new Error;throw d.name="MessageTypeMissingError",d}var v=new s;return v.__controls.initWithContent(c).catch(function(t){i.emit("error:"+t.name,t)}),{senderId:n,receiverId:e,withPeer:o||"group"===r?e:n,isFromMe:o,chatType:r,time:u,serial:t.serial,serverId:t.svr_msgid,message:v}},o.J=function(t,r,i){var n,e;switch(r){case"user":default:n=1;break;case"group":n=2}return e=0===i.getTypeId()&&"text"!==i.getType()?i.getType()+"!"+i.getContent():i.getContent(),{msgbodytype:i.getTypeId(),chattype:n,receiver:t,content:e}},o.prototype.z=function(t,r,i,n){return{senderId:this.n.get("userId"),receiverId:t,withPeer:t,isFromMe:!0,chatType:r,time:new Date,serverId:i,message:n}},o.prototype.H=function(t){if(this.N.has(t.serverId))return!1;var r=t.withPeer;switch(t.chatType){case"group":for(this.M[r]=this.M[r]||[],this.M[r].push(t),this.N.add(t.serverId);30<this.M[r].length;)(i=this.M[r].shift())&&this.N.delete(i.serverId);break;case"user":for(this.x[r]=this.x[r]||[],this.x[r].push(t),this.N.add(t.serverId);30<this.x[r].length;){var i;(i=this.x[r].shift())&&this.N.delete(i.serverId)}}return!0},o.prototype.W=function(t){return this.r.send(5,t)},o.prototype.K=function(t){var e=this;return t.__controls.onRequestUploadToken(function(t,r,i,n){return e.F(t,r,i,n)}),t.__controls.onRequestWechatToken(function(){return e.R()}),t.__controls.waitForContent().then(function(){return t}).catch(function(t){throw"CanceledError"===t.name&&e.emit("error:"+t.name,t),t})},o.prototype.F=function(t,r,i,n){return this.r.send(8,{filename:i,filesize:t,filemd5:r,filesuffix:n}).then(function(t){return{headers:t.headers,uploadUrl:t.token,downloadUrl:t.downloadurl}})},o.prototype.R=function(){var r=this,t=+new Date-+this.q;return this.S&&t<3e5?Promise.resolve(this.S):this.r.send(12,{}).then(function(t){return r.S=t.token,r.q=new Date,r.S})},o}(r);return function(i){function t(t){var r=i.call(this)||this;return r.o="",r.n=new o,r.r=new v(r.n),r.G=new s(r.n,r.r),r.Q=new u(r.n,r.r),r.V=new w(r.n,r.r),r.Y(),r.Z(),r.$(),r.tt(),r.it(),t&&r.init(t).then(),r}return e(t,i),t.prototype.init=function(t){var r=[];if(this.o=t.appKey,t.userId&&t.token&&r.push(this.login(t.userId,t.token,!0).then(function(){})),t.roomId){t.roomId instanceof Array||(t.roomId=[t.roomId]);for(var i=0,n=t.roomId;i<n.length;i++){var e=n[i];r.push(this.joinRoom(e).then(function(){}))}}return t.useMessageType&&this.registerMessageType(t.useMessageType),t.userId&&t.token?Promise.all(r).then(function(){}):Promise.resolve()},t.prototype.uninit=function(){this.logout()},t.prototype.login=function(t,r,i){return void 0===i&&(i=!1),this.G.login(this.o,t,r).catch(function(t){if(!i)throw t})},t.prototype.logout=function(){this.Q.clear(),this.V.clear(),this.G.logout()},t.prototype.isLogging=function(){return this.G.isLogging()},t.prototype.isLogged=function(){return this.G.isLogged()},t.prototype.getMyUserId=function(){return this.G.getMyUserId()},t.prototype.joinRoom=function(t){var r=this;return this.G.doIfLogged().then(function(){return r.Q.joinRoom(t)})},t.prototype.leaveRoom=function(t){var r=this;return this.G.doIfLogged().then(function(){return t?r.Q.leaveRoom(t):r.Q.leaveAllRoom()})},t.prototype.inRoom=function(t){return this.Q.inRoom(t)},t.prototype.getRoomIdList=function(){return this.Q.getRoomIdList()},t.prototype.registerMessageType=function(t){if(t instanceof Array)for(var r=0,i=t;r<i.length;r++){var n=i[r];this.V.registerMessageType(n)}else this.V.registerMessageType(t)},t.prototype.sendToRoom=function(t,r,i){var n=this;return void 0===i&&(i=!1),this.G.doIfLogged().then(function(){return n.Q.doIfJoinedRoom(t)}).then(function(){return n.V.sendToRoom(t,r)}).catch(function(t){if(!i&&(i=!0,!r.isCanceled()))throw t})},t.prototype.sendToUser=function(t,r,i){var n=this;return void 0===i&&(i=!1),this.G.doIfLogged().then(function(){return n.V.sendToUser(t,r)}).catch(function(t){if(!i&&(i=!0,!r.isCanceled()))throw t})},t.prototype.requestHistoryMessage=function(t,r,i,n){return this.V.requestHistoryMessage(t,r,i,n)},t.prototype.Y=function(){var t=this;this.r.on("status:reconnecting",function(){return t.G.reconnect().then(function(){return t.Q.reconnect()})})},t.prototype.Z=function(){var i=this;this.G.on("login",function(){return i.emit("account.login")}),this.G.on("logging",function(){return i.emit("account.logging")}),this.G.on("logout",function(){return i.emit("account.logout")}),this.G.on("kickoff",function(){return i.emit("account.kickoff")}),this.G.on("error:*",function(t,r){return i.emit("account."+t,r)})},t.prototype.$=function(){var n=this;this.Q.on("join:*",function(t,r){return n.emit("room.join:"+r,r)}),this.Q.on("joining:*",function(t,r){return n.emit("room.joining:"+r,r)}),this.Q.on("leave:*",function(t,r){return n.emit("room.leave:"+r,r)}),this.Q.on("join-error:*",function(t,r,i){return n.emit("room.join-error:"+r.name,r,i)}),this.Q.on("leave-error:*",function(t,r,i){return n.emit("room.leave-error:"+r.name,r,i)})},t.prototype.tt=function(){var n=this;this.V.on("send:*",function(t,r){return n.emit("message:send:"+r.chatType+":"+r.withPeer,r)}),this.V.on("send-failed:*",function(t,r,i){return n.emit("message:"+t,r,i)}),this.V.on("receive:*",function(t,r){return n.emit("message:receive:"+r.chatType+":"+r.withPeer,r)})},t.prototype.it=function(){var i=this;this.r.on("status:*",function(t,r){return i.emit("signaling.status:"+r,r)}),this.r.on("ready",function(){return i.emit("signaling.ready")}),this.r.on("message:*",function(t,r){return i.emit("signaling.receive:"+r.base.msgtype,r)}),this.r.on("send:*",function(t,r){return i.emit("signaling.send:"+r.base.msgtype,r)}),this.r.on("error",function(t){return i.emit("signaling.error",t)})},t.Message=g,t.WildEmitter=r,t}(r)}()}),c=t(function(t,r){t.exports=function(t){t=t&&t.hasOwnProperty("default")?t.default:t;var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])};return function(i){function t(t){var r=i.call(this)||this;return r.n="",r.typeId=0,r.typeName="text",void 0!==t&&r.setText(t),r}return function(t,r){function i(){this.constructor=t}n(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}(t,i),t.prototype.setText=function(t){this.n=t.toString(),this.setContent(this.n)},t.prototype.getText=function(){return this.n},t.prototype.initWithContent=function(t){return this.n=t.toString(),Promise.resolve()},t.filterDirty=function(t,r){return void 0===r&&(r="**"),this.t?t.replace(this.t,r):t},t.setDirtyWords=function(t){this.t=t?new RegExp(t.join("|"),"ig"):null},t.t=null,t}(t.Message)}(h)}),f=t(function(t,r){t.exports=function(t){t=t&&t.hasOwnProperty("default")?t.default:t;var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])},i=function(){function t(){var n=this;this.__uploadFn=null,this.__onSetUploadFn=[],this.__getWXTkFn=null,this.__onSetWXTkFn=[],this.__controls={setUploadFunc:function(t){n.__uploadFn=t;for(var r=0,i=n.__onSetUploadFn;r<i.length;r++)(0,i[r])();n.__onSetUploadFn=[]},setWechatTokenFunc:function(t){n.__getWXTkFn=t;for(var r=0,i=n.__onSetWXTkFn;r<i.length;r++)(0,i[r])();n.__onSetWXTkFn=[]}}}return t.prototype.getTypeId=function(){return this.typeId},t.prototype.getType=function(){return this.typeName},t.prototype.uploadFile=function(t){var r=this;return this.__uploadFn?this.__uploadFn(t):new Promise(function(t){r.__onSetUploadFn.push(t)}).then(function(){return r.__uploadFn(t)})},t.prototype.requestWechatToken=function(){var r=this;return this.__getWXTkFn?this.__getWXTkFn():new Promise(function(t){r.__onSetWXTkFn.push(t)}).then(function(){return r.__getWXTkFn()})},t}();return function(r){function o(){var t=null!==r&&r.apply(this,arguments)||this;return t.typeId=1,t.typeName="voice",t.t=null,t.i=null,t.r=!1,t.n=0,t}return function(t,r){function i(){this.constructor=t}n(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}(o,r),o.registerRecorder=function(t){for(var r=0,i=t;r<i.length;r++){var n=i[r],e=new n;e.isEnvSupport()&&(this.s.push(n),this.o.push(e))}},o.isEnvSupport=function(){return!!this.s.length},o.initRecorder=function(){return(new o).initRecord()},o.h=function(){var t=this;if(this.e[0]){var r=this.e[0];this.u.emit("begin-play",r),r.play(),r.on("end-play",function(){t.u.emit("end-play",r),t.e.shift(),t.e[0]&&t.u.emit("next",t.e[0]),t.h()})}else this.u.emit("all-ended")},o.addToAutoPlayQueue=function(t){this.e.push(t),this.u.emit("add",t),1===this.e.length&&this.h()},o.getAutoPlayQueueLength=function(){return this.e.length},o.getCurrentAutoPlayingMessage=function(){return this.e[0]},o.nextAutoPlay=function(){this.e.length&&(this.e[0].stop(),this.e.shift(),this.e[0]&&this.u.emit("next",this.e[0]),this.h())},o.stopAndClearAutoPlayQueue=function(){this.e.length&&(this.e[0].stop(),this.e=[],this.h())},o.bindAutoPlayEvent=function(t,r){this.u.on(""+t,r)},o.unbindAutoPlayEvent=function(t,r){this.u.off(""+t,r)},o.prototype.initWithContent=function(t){var r,i=this;try{r=JSON.parse(t)}catch(i){r=t}for(var n=0,e=o.s.length;n<e;n++)if(o.o[n].isSupportMsg(r))return this.t=new o.s[n],this.t.__controls.setUploadFunc(this.uploadFile.bind(this)),this.t.__controls.setWechatTokenFunc(this.requestWechatToken.bind(this)),this.t.initWithJsonMsg(r).then(function(){i.t.onPlayEnd(function(){i.emit("end-play")}),i.setContent(t)});return this.i=new Error("Unsupported voice message format."),this.i.name="UnsupportedVoiceFormatError",Promise.reject(this.i)},o.prototype.initRecord=function(){return o.isEnvSupport()?this.isReady()?(this.i=new Error,this.i.name="AlreadyReadyError"):this.isCanceled()&&(this.i=new Error,this.i.name="CanceledError"):(this.i=new Error,this.i.name="DeviceNotSupportedError"),this.i?(this.emit("error:"+this.i.name,this.i),Promise.reject(this.i)):this.t?Promise.resolve():(this.t=new o.s[0],this.t.__controls.setUploadFunc(this.uploadFile.bind(this)),this.t.__controls.setWechatTokenFunc(this.requestWechatToken.bind(this)),this.t.initRecord().catch(function(t){throw"NotSupportedError"===t.name&&(t.name="DeviceNotSupportedError"),t}))},o.prototype.startRecord=function(r){var i=this;return void 0===r&&(r=!1),this.r=!0,this.isCanceled()?(this.i=new Error,this.i.name="CanceledError",r?Promise.resolve():Promise.reject(this.i)):(this.i=null,this.initRecord().then(function(){if(!i.isCanceled())return i.t.onPlayEnd(function(){i.emit("end-play")}),i.t.onRecordEnd(function(){i.setContent(i.t.getJsonMsg()),i.emit("finish-record")}),i.t.startRecord()}).then(function(){if(i.isError()){if(i.t&&i.t.cancelRecord(),r)return;throw i.i}i.n=setTimeout(function(){i.r=!1},1e3),i.emit("start-record")}).catch(function(t){if(i.i=t,i.emit("error:"+t.name,t),i.cancelRecord(),!r)throw i.i}))},o.prototype.finishRecord=function(r){var i=this;return void 0===r&&(r=!1),this.i||(this.t?this.isCanceled()&&(this.i=new Error,this.i.name="CanceledError"):(this.i=new Error,this.i.name="RecorderNotStartedError")),this.i?(this.emit("error:"+this.i.name),r?Promise.resolve():Promise.reject(this.i)):this.r?(this.t&&this.t.cancelRecord(),this.setCanceled(),this.i=new Error,this.i.name="RecordTooShortError",this.emit("error:"+this.i.name),clearTimeout(this.n),r?Promise.resolve():Promise.reject(this.i)):(this.emit("finishing-record"),this.t.finishRecord().catch(function(t){if(i.setCanceled(),(i.i=t)&&t.name&&i.emit("error:"+t.name),!r)throw t}))},o.prototype.cancelRecord=function(){this.t&&this.t.cancelRecord(),this.setCanceled(),this.emit("cancel-record")},o.prototype.isRecording=function(){return!!this.t&&this.t.isRecording()},o.prototype.isError=function(){return!!this.i},o.prototype.getErrorName=function(){return this.i?this.i.name:""},o.prototype.play=function(){var t=this;this.onReady(function(){t.t.play(),t.emit("play")})},o.prototype.stop=function(){this.isReady()&&this.t&&this.t.isPlaying()&&(this.t.stop(),this.emit("stop"))},o.prototype.isPlaying=function(){return!!this.t&&this.t.isPlaying()},o.prototype.getDuration=function(){return this.t?this.t.getDuration():0},o.s=[],o.o=[],o.Recorder=i,o.e=[],o.u=new t.WildEmitter,o}(t.Message)}(h)});return function(e){e.debug=!1,e.isWeixin=function(){return!1};var o,t,r,s,i,n,u=function(){function t(t,r,i){var n=this;this.rt=null,this.nt=null,this.et=[],this.socketio=new h.WildEmitter,f.registerRecorder([]),c.setDirtyWords(t),this.newInstance=new h({appKey:r,useMessageType:[c,f]}),this.ot=i,this.newInstance.on("account.login",function(){i.onLogin&&i.onLogin(0,{code:0,message:"ok",data:{userid:n.newInstance.getMyUserId()}})}),this.newInstance.on("account.logout",function(){i.onLogout&&i.onLogout(0,{code:0,message:"ok",data:{userid:n.newInstance.getMyUserId()}})}),this.newInstance.on("account.kickoff",function(){i.onKickOff&&i.onKickOff()}),this.newInstance.on("account.error:UsernameOrTokenError",function(){i.onLogin&&i.onLogin(o.YIMErrorcode_USERNAME_TOKEN_ERROR,{code:o.YIMErrorcode_USERNAME_TOKEN_ERROR,message:"用户名或token错误",data:{userid:n.newInstance.getMyUserId()}})}),this.newInstance.on("room.join:*",function(t,r){i.onJoinChatRoom&&i.onJoinChatRoom(0,{code:0,message:"ok",data:{roomid:r}})}),this.newInstance.on("room.leave:*",function(t,r){i.onLeaveChatRoom&&i.onLeaveChatRoom(0,{code:0,message:"ok",data:{roomid:r}})}),this.newInstance.on("message:send:*",function(t,r){i.onSendMessageStatus&&i.onSendMessageStatus(0,{code:0,message:"ok",data:{msgid:parseInt(r.serial||"0")}})}),this.newInstance.on("message:send-failed:MessageTooLongError:*",function(){i.onSendMessageStatus&&i.onSendMessageStatus(20007,{code:20007,message:"Message too long.",data:{msgid:0}})}),this.newInstance.on("message:send-failed:NotLoginError:*",function(){i.onSendMessageStatus&&i.onSendMessageStatus(20001,{code:20001,message:"Not login.",data:{msgid:0}})}),this.newInstance.on("message:receive:*",function(t,r){i.onRecvMessage&&i.onRecvMessage({msgType:r.message.getTypeId(),senderid:r.serverId,recvid:r.receiverId,messageid:r.serial||"0",createtime:Math.round(r.time.getTime()/1e3),chattype:"user"===r.chatType?1:2,content:r.message.getContent(),final:!1,history:!1})}),this.newInstance.on("signaling.ready",function(){n.socketio.emit("connect")}),this.newInstance.on("signaling.error",function(t){n.socketio.emit("error",t),n.socketio.emit("connect_error",t)}),this.newInstance.on("signaling.send:*",function(t,r){n.socketio.emit("send","yim",JSON.stringify(r),r)}),this.newInstance.on("signaling.receive:*",function(t,r){n.socketio.emit("message",{target:n.newInstance,data:r}),n.socketio.emit("yim",r)}),this.newInstance.on("signaling.status:ended",function(){n.socketio.emit("close",{target:n.newInstance}),n.socketio.emit("disconnect",{target:n.newInstance})}),this.newInstance.on("*",function(t){e.debug&&console.log("[yim] "+t,arguments)})}return t.prototype.ready=function(t){this.newInstance.on("signaling.ready",t)},t.prototype.login=function(t,r){this.newInstance.login(t,r).catch()},t.prototype.logout=function(){this.newInstance.logout()},t.prototype.joinRoom=function(t){this.newInstance.joinRoom(t).catch()},t.prototype.leaveRoom=function(t){this.newInstance.leaveRoom(t).catch()},t.prototype.sendTextMessage=function(t,r,i){var n=new c(i);2===r?this.newInstance.sendToRoom(t,n).catch():this.newInstance.sendToUser(t,n).catch()},t.prototype.initAudioMedia=function(t,r){var i="webrtc";f.isEnvSupport()?f.initRecorder().then(function(){return r({type:i,support:!0})}).catch(function(){return r({type:i,support:!1})}):r({type:i,support:!1})},t.prototype.getSupportAudioMessage=function(){return f.isEnvSupport()},t.prototype.startAudioMessage=function(t,r,i){var e=this;!this.rt||this.rt.isReady()||this.rt.isCanceled()||this.cancelAudioMessage(),this.rt=new f,this.rt.startRecord().then(function(){return i(0,{errCode:0,errMsg:"ok"})}).catch(function(t){switch(t.name){case"DeviceNotSupportedError":i(o.YIMErrorcode_Fail,{errCode:s.WEBRTC_ERROR,errMsg:"当前浏览器不支持录音"});break;case"NotAllowedError":i(o.YIMErrorcode_Fail,{errCode:s.WEBRTC_ERROR,errMsg:"没有录音权限"});break;case"RecorderNotStartedError":i(o.YIMErrorcode_Fail,{errCode:s.INVALID_INVOKE,errMsg:"无效的调用"});break;case"RecorderBusyError":i(o.YIMErrorcode_Fail,{errCode:s.DUPLICATE_INVOKE,errMsg:"录音系统繁忙"});break;case"RecordTooShortError":i(o.YIMErrorcode_Fail,{errCode:s.VOICE_TOOSHORT,errMsg:"语音时长过短，请重新发送"})}});var n=function(t){if(t&&e.ot.onVoiceMsgSend){var r=e.rt.getContent(),i=r;try{var n=JSON.parse(r);r=n.downloadurl,i=n.mediaid}catch(t){}e.ot.onVoiceMsgSend(0,{msgID:t.serial||"0",voiceTime:e.rt.getDuration(),voiceURL:r,voiceServerID:i})}};2===r?this.newInstance.sendToRoom(t,this.rt).then(n).catch():this.newInstance.sendToUser(t,this.rt).then(n).catch()},t.prototype.cancelAudioMessage=function(){this.rt&&this.rt.cancelRecord()},t.prototype.stopAudioMessage=function(r){this.rt?this.rt.finishRecord().then(function(){return r(0,{errCode:0,errMsg:"ok"})}).catch(function(t){switch(t.name){case"DeviceNotSupportedError":r(o.YIMErrorcode_Fail,{errCode:s.WEBRTC_ERROR,errMsg:"当前浏览器不支持录音"});break;case"NotAllowedError":r(o.YIMErrorcode_Fail,{errCode:s.WEBRTC_ERROR,errMsg:"没有录音权限"});break;case"RecorderNotStartedError":r(o.YIMErrorcode_Fail,{errCode:s.INVALID_INVOKE,errMsg:"无效的调用"});break;case"RecorderBusyError":r(o.YIMErrorcode_Fail,{errCode:s.DUPLICATE_INVOKE,errMsg:"录音系统繁忙"});break;case"RecordTooShortError":r(o.YIMErrorcode_Fail,{errCode:s.VOICE_TOOSHORT,errMsg:"语音时长过短，请重新发送"})}}):r(o.YIMErrorcode_Fail,{errCode:s.INVALID_INVOKE,errMsg:"无效的调用"})},t.prototype.playAudioMessage=function(t,r){var i=this;this.nt&&this.nt.isPlaying()&&this.nt.stop();var n="//"===t.substr(0,2)||"http://"===t.substr(0,7)||"https:/"===t.substr(0,7)?{downloadurl:t}:{mediaid:t};this.nt=new f,this.nt.initWithContent(JSON.stringify(n)).then(function(){i.nt.play(),i.nt.once("end-play",function(){r(0,{errCode:0,errMsg:"ok"})})})},t.prototype.stopPlayAudioMessage=function(t,r){this.nt&&this.nt.isPlaying()&&(this.nt.stop(),r(0,{errCode:0,errMsg:"ok"}))},t.prototype.initAutoPlayVoiceQueue=function(t){var r=this;f.bindAutoPlayEvent("next",function(){r.et.unshift()}),f.bindAutoPlayEvent("begin-play",function(){t.beginPlay(r.et[0])}),f.bindAutoPlayEvent("end-play",function(){t.endPlay(r.et[0])})},t.prototype.addToAutoPlayVoiceQueue=function(t){var r=this;if("object"==typeof t&&t.content){var i=new f;i.initWithContent(t.content).then(function(){r.et.push(t),f.addToAutoPlayQueue(i)}).catch()}},t.prototype.getHistoryMessage=function(t,r,i,n){var e=this;this.newInstance.requestHistoryMessage(t,r,i,n).then(function(t){t.forEach(function(t){e.newInstance.emit("message:receive:"+t.chatType+":"+t.withPeer,t)})})},t.prototype.keywordsFilter=function(t){return c.filterDirty(t)},t}();e.getInstance=u,(t=o=e.YIMErrorcode||(e.YIMErrorcode={}))[t.YIMErrorcode_Success=0]="YIMErrorcode_Success",t[t.YIMErrorcode_EngineNotInit=1]="YIMErrorcode_EngineNotInit",t[t.YIMErrorcode_NotLogin=2]="YIMErrorcode_NotLogin",t[t.YIMErrorcode_ParamInvalid=3]="YIMErrorcode_ParamInvalid",t[t.YIMErrorcode_TimeOut=4]="YIMErrorcode_TimeOut",t[t.YIMErrorcode_StatusError=5]="YIMErrorcode_StatusError",t[t.YIMErrorcode_SDKInvalid=6]="YIMErrorcode_SDKInvalid",t[t.YIMErrorcode_AlreadyLogin=7]="YIMErrorcode_AlreadyLogin",t[t.YIMErrorcode_LoginInvalid=8]="YIMErrorcode_LoginInvalid",t[t.YIMErrorcode_ServerError=9]="YIMErrorcode_ServerError",t[t.YIMErrorcode_NetError=10]="YIMErrorcode_NetError",t[t.YIMErrorcode_LoginSessionError=11]="YIMErrorcode_LoginSessionError",t[t.YIMErrorcode_NotStartUp=12]="YIMErrorcode_NotStartUp",t[t.YIMErrorcode_FileNotExist=13]="YIMErrorcode_FileNotExist",t[t.YIMErrorcode_SendFileError=14]="YIMErrorcode_SendFileError",t[t.YIMErrorcode_UploadFailed=15]="YIMErrorcode_UploadFailed",t[t.YIMErrorcode_UsernamePasswordError=16]="YIMErrorcode_UsernamePasswordError",t[t.YIMErrorcode_UserStatusError=17]="YIMErrorcode_UserStatusError",t[t.YIMErrorcode_MessageTooLong=18]="YIMErrorcode_MessageTooLong",t[t.YIMErrorcode_ReceiverTooLong=19]="YIMErrorcode_ReceiverTooLong",t[t.YIMErrorcode_InvalidChatType=20]="YIMErrorcode_InvalidChatType",t[t.YIMErrorcode_InvalidReceiver=21]="YIMErrorcode_InvalidReceiver",t[t.YIMErrorcode_UnknowError=22]="YIMErrorcode_UnknowError",t[t.YIMErrorcode_InvalidAppkey=23]="YIMErrorcode_InvalidAppkey",t[t.YIMErrorcode_ForbiddenSpeak=24]="YIMErrorcode_ForbiddenSpeak",t[t.YIMErrorcode_CreateFileFailed=25]="YIMErrorcode_CreateFileFailed",t[t.YIMErrorcode_UnsupportFormat=26]="YIMErrorcode_UnsupportFormat",t[t.YIMErrorcode_ReceiverEmpty=27]="YIMErrorcode_ReceiverEmpty",t[t.YIMErrorcode_RoomIDTooLong=28]="YIMErrorcode_RoomIDTooLong",t[t.YIMErrorcode_ContentInvalid=29]="YIMErrorcode_ContentInvalid",t[t.YIMErrorcode_NoLocationAuthrize=30]="YIMErrorcode_NoLocationAuthrize",t[t.YIMErrorcode_UnknowLocation=31]="YIMErrorcode_UnknowLocation",t[t.YIMErrorcode_Unsupport=32]="YIMErrorcode_Unsupport",t[t.YIMErrorcode_NoAudioDevice=33]="YIMErrorcode_NoAudioDevice",t[t.YIMErrorcode_AudioDriver=34]="YIMErrorcode_AudioDriver",t[t.YIMErrorcode_DeviceStatusInvalid=35]="YIMErrorcode_DeviceStatusInvalid",t[t.YIMErrorcode_ResolveFileError=36]="YIMErrorcode_ResolveFileError",t[t.YIMErrorcode_ReadWriteFileError=37]="YIMErrorcode_ReadWriteFileError",t[t.YIMErrorcode_NoLangCode=38]="YIMErrorcode_NoLangCode",t[t.YIMErrorcode_TranslateUnable=39]="YIMErrorcode_TranslateUnable",t[t.YIMErrorcode_PTT_Start=40]="YIMErrorcode_PTT_Start",t[t.YIMErrorcode_PTT_Fail=41]="YIMErrorcode_PTT_Fail",t[t.YIMErrorcode_PTT_DownloadFail=42]="YIMErrorcode_PTT_DownloadFail",t[t.YIMErrorcode_PTT_GetUploadTokenFail=43]="YIMErrorcode_PTT_GetUploadTokenFail",t[t.YIMErrorcode_PTT_UploadFail=44]="YIMErrorcode_PTT_UploadFail",t[t.YIMErrorcode_PTT_NotSpeech=45]="YIMErrorcode_PTT_NotSpeech",t[t.YIMErrorcode_PTT_DeviceStatusError=46]="YIMErrorcode_PTT_DeviceStatusError",t[t.YIMErrorcode_PTT_IsSpeeching=47]="YIMErrorcode_PTT_IsSpeeching",t[t.YIMErrorcode_PTT_FileNotExist=48]="YIMErrorcode_PTT_FileNotExist",t[t.YIMErrorcode_PTT_ReachMaxDuration=49]="YIMErrorcode_PTT_ReachMaxDuration",t[t.YIMErrorcode_PTT_SpeechTooShort=50]="YIMErrorcode_PTT_SpeechTooShort",t[t.YIMErrorcode_PTT_StartAudioRecordFailed=51]="YIMErrorcode_PTT_StartAudioRecordFailed",t[t.YIMErrorcode_PTT_SpeechTimeout=52]="YIMErrorcode_PTT_SpeechTimeout",t[t.YIMErrorcode_PTT_IsPlaying=53]="YIMErrorcode_PTT_IsPlaying",t[t.YIMErrorcode_PTT_NotStartPlay=54]="YIMErrorcode_PTT_NotStartPlay",t[t.YIMErrorcode_PTT_CancelPlay=55]="YIMErrorcode_PTT_CancelPlay",t[t.YIMErrorcode_PTT_NotStartRecord=56]="YIMErrorcode_PTT_NotStartRecord",t[t.YIMErrorcode_Fail=57]="YIMErrorcode_Fail",t[t.YIMErrorcode_NOTLOGIN=58]="YIMErrorcode_NOTLOGIN",t[t.YIMErrorcode_INVALID_PARAM=59]="YIMErrorcode_INVALID_PARAM",t[t.YIMErrorcode_INVALID_LOGIN=60]="YIMErrorcode_INVALID_LOGIN",t[t.YIMErrorcode_USERNAME_TOKEN_ERROR=61]="YIMErrorcode_USERNAME_TOKEN_ERROR",t[t.YIMErrorcode_LOGIN_TIMEOUT=62]="YIMErrorcode_LOGIN_TIMEOUT",t[t.YIMErrorcode_SERVICE_OVERLOAD=63]="YIMErrorcode_SERVICE_OVERLOAD",t[t.YIMErrorcode_MSG_TOO_LONG=64]="YIMErrorcode_MSG_TOO_LONG",(r=e.MessageBodyType||(e.MessageBodyType={}))[r.MessageBodyType_Text=0]="MessageBodyType_Text",r[r.MessageBodyType_Voice=1]="MessageBodyType_Voice",r[r.WEIXIN=2]="WEIXIN",(i=s=e.YIMAudioCode||(e.YIMAudioCode={}))[i.INVOKE_TOOFAST=9001]="INVOKE_TOOFAST",i[i.WAITFOR_LASTINVOKE=9002]="WAITFOR_LASTINVOKE",i[i.INVALID_INVOKE=9003]="INVALID_INVOKE",i[i.DUPLICATE_INVOKE=9004]="DUPLICATE_INVOKE",i[i.INVOKE_OUTTIME=9005]="INVOKE_OUTTIME",i[i.VOICE_TOOSHORT=9006]="VOICE_TOOSHORT",i[i.WEBRTC_ERROR=9089]="WEBRTC_ERROR",i[i.INVOKE_ERROR=9090]="INVOKE_ERROR",(n=e.MessageVoiceType||(e.MessageVoiceType={}))[n.WEIXIN=1]="WEIXIN",n[n.WEBRTC=2]="WEBRTC"}(r||(r={})),r});
