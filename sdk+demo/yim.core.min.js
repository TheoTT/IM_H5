!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.YIM=n()}(this,function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])};function e(t,n){function i(){this.constructor=t}r(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}var n=t;function t(){}t.mixin=function(t){var n=t.prototype||t;n.isWildEmitter=!0,n.on=function(t,n,i){this.callbacks=this.callbacks||{};var r=3===arguments.length,e=r?n:void 0,s=r?i:n;return s.t=e,(this.callbacks[t]=this.callbacks[t]||[]).push(s),this},n.once=function(n,t,i){var r=this,e=3===arguments.length,s=e?t:void 0,o=e?i:t;return this.on(n,s,function t(){r.off(n,t),o.apply(this,arguments)}),this},n.releaseGroup=function(t){var n,i,r,e;for(n in this.callbacks=this.callbacks||{},this.callbacks)for(i=0,r=(e=this.callbacks[n]).length;i<r;i++)e[i].t===t&&(e.splice(i,1),i--,r--);return this},n.off=function(t,n){this.callbacks=this.callbacks||{};var i,r=this.callbacks[t];return r&&(1===arguments.length?delete this.callbacks[t]:(i=r.indexOf(n),r.splice(i,1),0===r.length&&delete this.callbacks[t])),this},n.emit=function(t){this.callbacks=this.callbacks||{};var n,i,r,e=[].slice.call(arguments,1),s=this.callbacks[t],o=this.getWildcardCallbacks(t);if(s)for(n=0,i=(r=s.slice()).length;n<i&&r[n];++n)r[n].apply(this,e);if(o)for(i=o.length,n=0,i=(r=o.slice()).length;n<i&&r[n];++n)r[n].apply(this,[t].concat(e));return this},n.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var n,i,r=[];for(n in this.callbacks)i=n.split("*"),("*"===n||2===i.length&&t.slice(0,i[0].length)===i[0])&&(r=r.concat(this.callbacks[n]));return r}},t.mixin(t);var s=function(n){function t(){var t=n.call(this)||this;return t.n={appKey:"",userId:"",token:""},t}return e(t,n),t.prototype.set=function(t,n){this.n[t]=n,this.emit("change:"+t,t,n)},t.prototype.get=function(t){return this.n[t]},t}(n),o=function(r){function t(t,n){var i=r.call(this)||this;return i.i=t,i.r=n,i.e=!1,i.s=!1,i.o="",i.u="",i.h="",i.f=6,i.r.on("message:7",function(){i.r.close(),i.s=!1,i.emit("kickoff")}),i}return e(t,r),t.prototype.login=function(t,n,i){var r=this;return this.s?n!==this.u?(this.logout(),new Promise(function(t){setTimeout(function(){return t()},100)}).then(function(){return r.login(t,n,i)})):Promise.resolve():(this.e=!0,this.i.set("appKey",t),this.i.set("userId",n),this.i.set("token",i),this.o=t,this.u=n,this.h=i,this.emit("logging"),this.r.send(1,{appkey:t,userid:n+"",session:i+"",notify:1,base:{os_type:this.f,ip:"",port:0}}).then(function(){r.e=!1,r.s=!0,r.emit("login")}).catch(function(t){throw r.e=!1,r.s=!1,r.r.close(),r.emit("error:"+t.name,t),t}))},t.prototype.logout=function(){this.r.close(),this.s=!1,this.emit("logout")},t.prototype.isLogging=function(){return this.e},t.prototype.isLogged=function(){return this.s},t.prototype.doIfLogged=function(){var e=this;return new Promise(function(t,n){if(e.s)t();else{var i=setTimeout(function(){e.off("login",r);var t=new Error;t.name="NotLoginError",n(t)},1e4),r=function(){t(),clearTimeout(i)};e.once("login",r)}})},t.prototype.getMyUserId=function(){return this.u},t.prototype.reconnect=function(){return this.s=!1,this.login(this.o,this.u,this.h)},t}(n),u=function(r){function t(t,n){var i=r.call(this)||this;return i.i=t,i.r=n,i.c={},i.r.on("status:ended",function(){return i.clear()}),i}return e(t,r),t.prototype.joinRoom=function(n){var i=this;return n+="",this.c[n]||(this.c[n]=[this.i.get("userId")]),this.emit("joining:"+n,n),this.r.send(3,{roomid:n}).then(function(t){return i.emit("join:"+n,n),n}).catch(function(t){throw i.emit("join-error:"+t.name,t,n),delete i.c[n],t})},t.prototype.leaveRoom=function(n){var i=this;return n+="",this.r.send(4,{roomid:n}).then(function(){delete i.c[n],i.emit("leave:"+n,n)}).catch(function(t){throw i.emit("leave-error:"+t.name,t,n),t})},t.prototype.leaveAllRoom=function(){for(var t=[],n=0,i=Object.keys(this.c);n<i.length;n++){var r=i[n];t.push(this.leaveRoom(r))}return Promise.all(t).then(function(){})},t.prototype.clear=function(){for(var t=0,n=Object.keys(this.c);t<n.length;t++){var i=n[t];this.emit("leave:"+i,i)}this.c={}},t.prototype.doIfJoinedRoom=function(n){var i=this;return new Promise(function(t){n+="",i.inRoom(n)?t():i.once("join:"+n,function(){return t()})})},t.prototype.inRoom=function(t){return t+="",!!this.c[t]},t.prototype.getRoomIdList=function(){return Object.keys(this.c)},t.prototype.reconnect=function(){for(var n=this,t=function(t){i.r.send(4,{roomid:t}).then(function(){return n.r.send(3,{roomid:t})})},i=this,r=0,e=this.getRoomIdList();r<e.length;r++){t(e[r])}},t}(n),h="wss://webrtctest.youme.im",f=function(t){return t?"wss://"+t.substr(t.length-8).toLowerCase()+".h5.youme.im:443":""},c="disconnected",a="connected",v="reconnecting",l="ended",d={0:"OK",20001:"NotLoginError",20002:"InvalidParamError",20003:"InvalidLoginError",20004:"UsernameOrTokenError",20005:"LoginTimeoutError",20006:"ServiceOverloadError",20007:"MessageTooLongError"},m=function(i){function t(t){var n=i.call(this)||this;return n.i=t,n.a=1,n.f=6,n.v=null,n.l=h,n.d=c,n.m=[],n.w={},n.g={},n.y={},n.p=!1,n.b=[],n.A=[],n.k=Date.now(),n.j=0,n}return e(t,i),t.prototype.init=function(t){return t||(t=f(this.i.get("appKey"))),t&&(this.l=t,this.P(),this.T("connecting")),this},t.prototype.send=function(i,t){var r=this;if((this.d===c||this.d===l)&&(this.init(),this.d===c||this.d===l)){var n=new Error;return n.name="NotLoginError",Promise.reject(n)}return this.k++,t.base=t.base||{},t.base=Object.assign(t.base,{msgtype:i,seq:this.k+"",version:this.a,os_type:this.f}),this.m.push(t),this.S(),this.j&&clearTimeout(this.j),this.j=setTimeout(function(){return r.O()},6e4),new Promise(function(t,n){r.w[r.k]=t,r.g[r.k]=n,r.y[i]=r.k})},t.prototype.getStatus=function(){return this.d},t.prototype.close=function(){this.T(l),this.v&&(this.v.close(),this.v=null),this.m=[],this.w={},this.k=0,this.j&&(clearTimeout(this.j),this.j=0)},t.prototype.checkNetwork=function(){var i=this;return new Promise(function(t,n){i.b.push(t),i.A.push(n),i.p||i.O()})},t.prototype.P=function(){this.v&&this.v.close(),console.log("start connect"),"undefined"!=typeof uni&&uni.connectSocket?this.v=uni.connectSocket({url:this.l,success:function(){console.log("connectSocket success")},fail:function(){console.log("connectSocket fail")},complete:function(){console.log("connectSocket complete")}}):(console.log("connectSocket"),this.v=new WebSocket(this.l)),this.I()},t.prototype.x=function(){var t=this;if(this.d!==l){if(this.d!==v){for(var n in this.g)this.g.hasOwnProperty(n)&&this.g[n](new DOMException("Socket was closed.","NetworkError"));this.w={},this.g={},this.T(v)}this.v=null,setTimeout(function(){t.d===v&&t.P()},1e3)}this.j&&(clearTimeout(this.j),this.j=0)},t.prototype.I=function(){var u=this;console.log("socketEvent:"+this.v),this.v&&("undefined"!=typeof uni?(this.v.onOpen(function(t){console.log("WebSocket连接已打开"),u.T(a),u.emit("ready"),u.S()}),this.v.onError(function(t){console.log("WebSocket连接打开失败"),u.emit("error",t)}),this.v.onClose(function(t){console.log("WebSocket连接已关闭")})):(this.v.addEventListener("open",function(){u.T(a),u.emit("ready"),u.S()}),this.v.addEventListener("error",function(t){u.emit("error",t)}),this.v.addEventListener("close",function(){u.x()}),this.v.addEventListener("message",function(t){var n=JSON.parse(t.data),i=n.ret,r=n.base,e=r.msgtype,s=r.seq;if(s||(s=u.y[e]),s&&u.w[s]){if(i&&"0"!==i){var o=new Error;o.name=d[i]||"Error-"+i,u.g[s](o)}else u.w[s](n);delete u.w[s],delete u.g[s]}u.emit("message:"+e,n)})))},t.prototype.T=function(t){this.d!==t&&(this.d=t,this.emit("status:"+t,t))},t.prototype.S=function(){if(this.d===a&&this.v){for(var t=0,n=this.m;t<n.length;t++){var i=n[t];"undefined"!=typeof uni?this.v.send({data:JSON.stringify(i)}):this.v.send(JSON.stringify(i));var r=i.base;this.emit("send:"+r.msgtype,i)}this.m=[]}},t.prototype.O=function(){var t=this;if(!this.p){this.p=!0;var n=setTimeout(function(){t.B(!1),t.v&&t.v.close(),t.x()},1e4);this.send(0,{}).then(function(){clearTimeout(n),t.B(!0)}).catch(function(){clearTimeout(n),t.B(!1)})}},t.prototype.B=function(t){if(t)for(var n=0,i=this.b;n<i.length;n++){var r=i[n];r&&r()}else for(var e=0,s=this.A;e<s.length;e++){var o=s[e];o&&o()}this.b=[],this.A=[],this.p=!1},t}(n),b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var i,w=(function(p){!function(){var f="input is invalid type",t="object"==typeof window,n=t?window:{};n.JS_MD5_NO_WINDOW&&(t=!1);var i=!t&&"object"==typeof self,r=!n.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;r?n=b:i&&(n=self);var e,s=!n.JS_MD5_NO_COMMON_JS&&p.exports,c=!n.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,o="0123456789abcdef".split(""),u=[128,32768,8388608,-2147483648],a=[0,8,16,24],h=["hex","array","digest","buffer","arrayBuffer","base64"],v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),l=[];if(c){var d=new ArrayBuffer(68);e=new Uint8Array(d),l=new Uint32Array(d)}!n.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),!c||!n.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(t){return"object"==typeof t&&t.buffer&&t.buffer.constructor===ArrayBuffer});var m=function(n){return function(t){return new g(!0).update(t)[n]()}},w=function(n){var i=[eval][0]("require('crypto')"),r=[eval][0]("require('buffer').Buffer");return function(t){if("string"==typeof t)return i.createHash("md5").update(t,"utf8").digest("hex");if(null==t)throw f;return t.constructor===ArrayBuffer&&(t=new Uint8Array(t)),Array.isArray(t)||ArrayBuffer.isView(t)||t.constructor===r?i.createHash("md5").update(new r(t)).digest("hex"):n(t)}};function g(t){if(t)l[0]=l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0,this.blocks=l,this.buffer8=e;else if(c){var n=new ArrayBuffer(68);this.buffer8=new Uint8Array(n),this.blocks=new Uint32Array(n)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}g.prototype.update=function(t){if(!this.finalized){var n,i=typeof t;if("string"!==i){if("object"!==i)throw f;if(null===t)throw f;if(c&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||c&&ArrayBuffer.isView(t)))throw f;n=!0}for(var r,e,s=0,o=t.length,u=this.blocks,h=this.buffer8;s<o;){if(this.hashed&&(this.hashed=!1,u[0]=u[16],u[16]=u[1]=u[2]=u[3]=u[4]=u[5]=u[6]=u[7]=u[8]=u[9]=u[10]=u[11]=u[12]=u[13]=u[14]=u[15]=0),n)if(c)for(e=this.start;s<o&&e<64;++s)h[e++]=t[s];else for(e=this.start;s<o&&e<64;++s)u[e>>2]|=t[s]<<a[3&e++];else if(c)for(e=this.start;s<o&&e<64;++s)(r=t.charCodeAt(s))<128?h[e++]=r:(r<2048?h[e++]=192|r>>6:(r<55296||57344<=r?h[e++]=224|r>>12:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++s)),h[e++]=240|r>>18,h[e++]=128|r>>12&63),h[e++]=128|r>>6&63),h[e++]=128|63&r);else for(e=this.start;s<o&&e<64;++s)(r=t.charCodeAt(s))<128?u[e>>2]|=r<<a[3&e++]:(r<2048?u[e>>2]|=(192|r>>6)<<a[3&e++]:(r<55296||57344<=r?u[e>>2]|=(224|r>>12)<<a[3&e++]:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++s)),u[e>>2]|=(240|r>>18)<<a[3&e++],u[e>>2]|=(128|r>>12&63)<<a[3&e++]),u[e>>2]|=(128|r>>6&63)<<a[3&e++]),u[e>>2]|=(128|63&r)<<a[3&e++]);this.lastByteIndex=e,this.bytes+=e-this.start,64<=e?(this.start=e-64,this.hash(),this.hashed=!0):this.start=e}return 4294967295<this.bytes&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},g.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,n=this.lastByteIndex;t[n>>2]|=u[3&n],56<=n&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},g.prototype.hash=function(){var t,n,i,r,e,s,o=this.blocks;this.first?n=((n=((t=((t=o[0]-680876937)<<7|t>>>25)-271733879<<0)^(i=((i=(-271733879^(r=((r=(-1732584194^2004318071&t)+o[1]-117830708)<<12|r>>>20)+t<<0)&(-271733879^t))+o[2]-1126478375)<<17|i>>>15)+r<<0)&(r^t))+o[3]-1316259209)<<22|n>>>10)+i<<0:(t=this.h0,n=this.h1,i=this.h2,n=((n+=((t=((t+=((r=this.h3)^n&(i^r))+o[0]-680876936)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[1]-389564586)<<12|r>>>20)+t<<0)&(t^n))+o[2]+606105819)<<17|i>>>15)+r<<0)&(r^t))+o[3]-1044525330)<<22|n>>>10)+i<<0),n=((n+=((t=((t+=(r^n&(i^r))+o[4]-176418897)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[5]+1200080426)<<12|r>>>20)+t<<0)&(t^n))+o[6]-1473231341)<<17|i>>>15)+r<<0)&(r^t))+o[7]-45705983)<<22|n>>>10)+i<<0,n=((n+=((t=((t+=(r^n&(i^r))+o[8]+1770035416)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[9]-1958414417)<<12|r>>>20)+t<<0)&(t^n))+o[10]-42063)<<17|i>>>15)+r<<0)&(r^t))+o[11]-1990404162)<<22|n>>>10)+i<<0,n=((n+=((t=((t+=(r^n&(i^r))+o[12]+1804603682)<<7|t>>>25)+n<<0)^(i=((i+=(n^(r=((r+=(i^t&(n^i))+o[13]-40341101)<<12|r>>>20)+t<<0)&(t^n))+o[14]-1502002290)<<17|i>>>15)+r<<0)&(r^t))+o[15]+1236535329)<<22|n>>>10)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[1]-165796510)<<5|t>>>27)+n<<0)^n))+o[6]-1069501632)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[11]+643717713)<<14|i>>>18)+r<<0)^r))+o[0]-373897302)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[5]-701558691)<<5|t>>>27)+n<<0)^n))+o[10]+38016083)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[15]-660478335)<<14|i>>>18)+r<<0)^r))+o[4]-405537848)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[9]+568446438)<<5|t>>>27)+n<<0)^n))+o[14]-1019803690)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[3]-187363961)<<14|i>>>18)+r<<0)^r))+o[8]+1163531501)<<20|n>>>12)+i<<0,n=((n+=((r=((r+=(n^i&((t=((t+=(i^r&(n^i))+o[13]-1444681467)<<5|t>>>27)+n<<0)^n))+o[2]-51403784)<<9|r>>>23)+t<<0)^t&((i=((i+=(t^n&(r^t))+o[7]+1735328473)<<14|i>>>18)+r<<0)^r))+o[12]-1926607734)<<20|n>>>12)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[5]-378558)<<4|t>>>28)+n<<0))+o[8]-2022574463)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[11]+1839030562)<<16|i>>>16)+r<<0))+o[14]-35309556)<<23|n>>>9)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[1]-1530992060)<<4|t>>>28)+n<<0))+o[4]+1272893353)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[7]-155497632)<<16|i>>>16)+r<<0))+o[10]-1094730640)<<23|n>>>9)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[13]+681279174)<<4|t>>>28)+n<<0))+o[0]-358537222)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[3]-722521979)<<16|i>>>16)+r<<0))+o[6]+76029189)<<23|n>>>9)+i<<0,n=((n+=((s=(r=((r+=((e=n^i)^(t=((t+=(e^r)+o[9]-640364487)<<4|t>>>28)+n<<0))+o[12]-421815835)<<11|r>>>21)+t<<0)^t)^(i=((i+=(s^n)+o[15]+530742520)<<16|i>>>16)+r<<0))+o[2]-995338651)<<23|n>>>9)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[0]-198630844)<<6|t>>>26)+n<<0)|~i))+o[7]+1126891415)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[14]-1416354905)<<15|i>>>17)+r<<0)|~t))+o[5]-57434055)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[12]+1700485571)<<6|t>>>26)+n<<0)|~i))+o[3]-1894986606)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[10]-1051523)<<15|i>>>17)+r<<0)|~t))+o[1]-2054922799)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[8]+1873313359)<<6|t>>>26)+n<<0)|~i))+o[15]-30611744)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[6]-1560198380)<<15|i>>>17)+r<<0)|~t))+o[13]+1309151649)<<21|n>>>11)+i<<0,n=((n+=((r=((r+=(n^((t=((t+=(i^(n|~r))+o[4]-145523070)<<6|t>>>26)+n<<0)|~i))+o[11]-1120210379)<<10|r>>>22)+t<<0)^((i=((i+=(t^(r|~n))+o[2]+718787259)<<15|i>>>17)+r<<0)|~t))+o[9]-343485551)<<21|n>>>11)+i<<0,this.first?(this.h0=t+1732584193<<0,this.h1=n-271733879<<0,this.h2=i-1732584194<<0,this.h3=r+271733878<<0,this.first=!1):(this.h0=this.h0+t<<0,this.h1=this.h1+n<<0,this.h2=this.h2+i<<0,this.h3=this.h3+r<<0)},g.prototype.toString=g.prototype.hex=function(){this.finalize();var t=this.h0,n=this.h1,i=this.h2,r=this.h3;return o[t>>4&15]+o[15&t]+o[t>>12&15]+o[t>>8&15]+o[t>>20&15]+o[t>>16&15]+o[t>>28&15]+o[t>>24&15]+o[n>>4&15]+o[15&n]+o[n>>12&15]+o[n>>8&15]+o[n>>20&15]+o[n>>16&15]+o[n>>28&15]+o[n>>24&15]+o[i>>4&15]+o[15&i]+o[i>>12&15]+o[i>>8&15]+o[i>>20&15]+o[i>>16&15]+o[i>>28&15]+o[i>>24&15]+o[r>>4&15]+o[15&r]+o[r>>12&15]+o[r>>8&15]+o[r>>20&15]+o[r>>16&15]+o[r>>28&15]+o[r>>24&15]},g.prototype.array=g.prototype.digest=function(){this.finalize();var t=this.h0,n=this.h1,i=this.h2,r=this.h3;return[255&t,t>>8&255,t>>16&255,t>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,255&i,i>>8&255,i>>16&255,i>>24&255,255&r,r>>8&255,r>>16&255,r>>24&255]},g.prototype.buffer=g.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),n=new Uint32Array(t);return n[0]=this.h0,n[1]=this.h1,n[2]=this.h2,n[3]=this.h3,t},g.prototype.base64=function(){for(var t,n,i,r="",e=this.array(),s=0;s<15;)t=e[s++],n=e[s++],i=e[s++],r+=v[t>>>2]+v[63&(t<<4|n>>>4)]+v[63&(n<<2|i>>>6)]+v[63&i];return t=e[s],r+=v[t>>>2]+v[t<<4&63]+"=="};var y=function(){var n=m("hex");r&&(n=w(n)),n.create=function(){return new g},n.update=function(t){return n.create().update(t)};for(var t=0;t<h.length;++t){var i=h[t];n[i]=m(i)}return n}();s?p.exports=y:n.md5=y}()}(i={exports:{}},i.exports),i.exports),g=(w.hex,w.array,w.digest,w.arrayBuffer,w.buffer,w.create),y=(w.update,w.base64,function(t){function c(){var i=null!==t&&t.apply(this,arguments)||this;return i.__isReady=!1,i.__isCanceled=!1,i.__reqUpTk=null,i.__reqWXTk=null,i.__onReadyQueue=[],i.__onCancelQueue=[],i.__onSetUpTkFn=[],i.__onSetWXTkFn=[],i.__content="",i.__extraParam="",i.typeId=0,i.__controls={initWithContent:function(t,n){return i.initWithContent(t,n).then(function(){return i.setContent(t)})},getContent:function(){return i.getContent()},getTypeId:function(){return i.getTypeId()},getType:function(){return i.getType()},onRequestUploadToken:function(t){return i.__onReqUpTk(t)},onRequestWechatToken:function(t){return i.__onReqWXTk(t)},waitForContent:function(){return i.__waitForContent()}},i}return e(c,t),c.prototype.setContent=function(t){this.__content="string"==typeof t?t:JSON.stringify(t),this.__isReady=!0;for(var n=0,i=this.__onReadyQueue;n<i.length;n++){(0,i[n])(this.__content)}this.__onReadyQueue=[]},c.prototype.setExtraParam=function(t){this.__extraParam="string"==typeof t?t:JSON.stringify(t)},c.prototype.setCanceled=function(){this.__isCanceled=!0;for(var t=0,n=this.__onCancelQueue;t<n.length;t++){var i=n[t],r=new Error("Message Canceled.");r.name="CanceledError",i(r)}this.__onCancelQueue=[]},c.prototype.uploadFile=function(h){var f=this;return new Promise(function(s,o){var e,u=new FileReader;u.onload=function(){if(!(e=u.result)){var t=new Error;return t.name="UploadFileError",o(t)}var n=g();n.update(e);var i=n.hex(),r=function(i){var r=new XMLHttpRequest;r.ontimeout=function(t){o(t)},r.onerror=function(t){o(t)},r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var t=i.downloadUrl,n=t.indexOf(":");-1<n&&n<7&&(t=t.substr(n+1)),s(t)}};var t=i.uploadUrl,n=t.indexOf(":");for(var e in-1<n&&n<7&&(t=t.substr(n+1)),r.open("PUT",t,!0),r.timeout=6e4,i.headers)"host"!==e&&i.headers.hasOwnProperty(e)&&r.setRequestHeader(e,i.headers[e]);r.send(h)};if(f.__reqUpTk)f.__reqUpTk(h.size,i,i,h.type.split("/")[1]).then(r).catch(function(t){return o(t)});else if(c.__gControls.reqUpTk)c.__gControls.reqUpTk(h.size,i,i,h.type.split("/")[1]).then(r).catch(function(t){return o(t)});else{new Promise(function(t){f.__onSetUpTkFn.push(t)}).then(function(){f.__reqUpTk(h.size,i,i,h.type.split("/")[1]).then(r).catch(function(t){return o(t)})})}},u.readAsArrayBuffer(h)})},c.prototype.requestWechatToken=function(){var n=this;return this.__reqWXTk?this.__reqWXTk():c.__gControls.reqWXTk?c.__gControls.reqWXTk():new Promise(function(t){n.__onSetWXTkFn.push(t)}).then(function(){return n.__reqWXTk()})},c.prototype.isReady=function(){return this.__isReady},c.prototype.isCanceled=function(){return this.__isCanceled},c.prototype.onReady=function(t,n){if(this.__isReady)return t();this.__isCanceled?n&&n():this.__waitForContent().then(function(){t()}).catch(function(t){"CanceledError"===t.name&&n&&n()})},c.prototype.getContent=function(){var t;if(this.__isCanceled)throw(t=new Error("Message Canceled.")).name="CanceledError",t;if(!this.__isReady)throw(t=new Error("Content is not ready yet.")).name="ContentNotReadyError",t;return this.__content},c.prototype.getExtraParam=function(){return this.__extraParam},c.prototype.getTypeId=function(){return this.typeId},c.prototype.getType=function(){return this.typeName},c.prototype.__onReqUpTk=function(t){this.__reqUpTk=t;for(var n=0,i=this.__onSetUpTkFn;n<i.length;n++){(0,i[n])()}this.__onSetUpTkFn=[]},c.prototype.__onReqWXTk=function(t){this.__reqWXTk=t;for(var n=0,i=this.__onSetWXTkFn;n<i.length;n++){(0,i[n])()}this.__onSetWXTkFn=[]},c.prototype.__waitForContent=function(){var i=this;if(this.__isReady)return Promise.resolve(this.__content);if(this.__isCanceled){var t=new Error("Message Canceled.");return t.name="CanceledError",Promise.reject(t)}return new Promise(function(t,n){i.__onReadyQueue.push(t),i.__onCancelQueue.push(n)})},c.__gControls={},c}(n)),p=function(r){function s(t,n){var i=r.call(this)||this;return i.i=t,i.r=n,i.C={},i.N={},i.U=new Set,i.M={},i.J={},i._="",i.D=new Date(0),i.r.on("message:9",function(t){if(t&&"object"==typeof t.args){console.warn("init msgid:"+JSON.stringify(t));var n=0;n=t.args.msg_for?0:parseInt(t.args.msg_id)-1,i.r.send(10,{msgid:n+""}).then(function(t){i.L(t)})}}),y.__gControls.reqUpTk=i.q.bind(i),y.__gControls.reqWXTk=i.F.bind(i),i}return e(s,r),s.prototype.registerMessageType=function(t){var n=new t,i=n.__controls.getTypeId(),r=n.__controls.getType();0===i&&"text"!==r?this.J[r]=t:this.M[i]=t},s.prototype.sendToRoom=function(i,r){var e=this;return i+="",this.W(r).then(function(n){var t=s.R(i,"group",n);return e.K(t).then(function(t){var n=e.z(i,"group",t.svr_msgid,r);return e.H(n),e.emit("send:group:"+i,n),n}).catch(function(t){throw e.emit("send-failed:"+t.name+":group:"+i+":"+t.name,n,t),t})})},s.prototype.sendToUser=function(i,r){var e=this;return this.W(r).then(function(n){var t=s.R(i,"user",n);return e.K(t).then(function(t){var n=e.z(i,"user",t.svr_msgid,r);return e.H(n),e.emit("send:user:"+i,n),n}).catch(function(t){throw e.emit("send-failed:"+t.name+":user:"+i,n,t),t})})},s.prototype.requestHistoryMessage=function(t,n,i,r){var o=this;return this.r.send(11,{interlocutor:t,min_msgid:n,max_msgid:i,day_interval:r}).then(function(t){for(var n=[],i=0,r=t.msg_list;i<r.length;i++){var e=r[i],s=o.X(e);n.push(s)}return n})},s.prototype.clear=function(){this.C={},this.N={},this.U.clear()},s.prototype.L=function(t){for(var e=this,n=t.msg_list,i=function(t){var n=s.X(t),i=n.withPeer,r=n.chatType;s.H(n)&&s.W(n.message).then(function(){e.emit("receive:"+r+":"+i,n)})},s=this,r=0,o=n;r<o.length;r++){i(o[r])}},s.prototype.X=function(t){var n,i=this,r=t.sender,e=t.receiver,s=t.sender===this.i.get("userId");if(t&&1==t.msgtype&&t.comment&&!t.comment.h5){var o=t.content;/^https:/i.test(o)&&(o=o.replace(/^https:/i,"")),t.content=JSON.stringify({datasize:parseInt(t.comment.FileSize),downloadurl:o,voicetime:t.comment.Time,AudioText:t.comment?t.comment.AudioText:"",comment:t.comment,recordmode:2,extra:t.comment.Param})}switch(t.chattype){case 1:default:n="user";break;case 2:n="group"}var u,h=new Date(1e3*t.timespan),f=t.msgtype,c=t.content;if(0===f){var a=c.match(/^(.+?)!/),v=a?a[1]:null;v?(c=c.replace(/^(.+?)!/,""),u=this.J[v]):u=this.M[0]}else u=this.M[f];if(!u){var l=new Error;throw l.name="MessageTypeMissingError",l}var d=new u,m=t&&t.comment&&t.comment.AttachParam?t.comment.AttachParam:"";return!m&&t&&t.comment&&t.comment.Param&&(m=t.comment.Param),d.__controls.initWithContent(c,m).catch(function(t){i.emit("error:"+t.name,t)}),{senderId:r,receiverId:e,withPeer:s||"group"===n?e:r,isFromMe:s,chatType:n,time:h,serial:t.serial,serverId:t.svr_msgid,message:d}},s.R=function(t,n,i){var r,e;switch(n){case"user":default:r=1;break;case"group":r=2}if(e=0===i.getTypeId()&&"text"!==i.getType()?i.getType()+"!"+i.getContent():i.getContent(),"text"===i.getType())return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{AttachParam:i.getExtraParam()}};if("voice"===i.getType()){var s=JSON.parse(e);return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{h5:"true",Param:s.extra+"",FileSize:s.datasize+"",Time:parseInt(s.voicetime)+""}}}return{msgbodytype:i.getTypeId(),chattype:r,receiver:t,content:e,comment:{AttachParam:i.getExtraParam()}}},s.prototype.z=function(t,n,i,r){return{senderId:this.i.get("userId"),receiverId:t,withPeer:t,isFromMe:!0,chatType:n,time:new Date,serverId:i,message:r}},s.prototype.H=function(t){if(this.U.has(t.serverId))return!1;var n=t.withPeer;switch(t.chatType){case"group":for(this.N[n]=this.N[n]||[],this.N[n].push(t),this.U.add(t.serverId);30<this.N[n].length;){(i=this.N[n].shift())&&this.U.delete(i.serverId)}break;case"user":for(this.C[n]=this.C[n]||[],this.C[n].push(t),this.U.add(t.serverId);30<this.C[n].length;){var i;(i=this.C[n].shift())&&this.U.delete(i.serverId)}}return!0},s.prototype.K=function(t){return this.r.send(5,t)},s.prototype.W=function(t){var e=this;return t.__controls.onRequestUploadToken(function(t,n,i,r){return e.q(t,n,i,r)}),t.__controls.onRequestWechatToken(function(){return e.F()}),t.__controls.waitForContent().then(function(){return t}).catch(function(t){throw"CanceledError"===t.name&&e.emit("error:"+t.name,t),t})},s.prototype.q=function(t,n,i,r){return this.r.send(8,{filename:i,filesize:t,filemd5:n,filesuffix:r}).then(function(t){return{headers:t.headers,uploadUrl:t.token,downloadUrl:t.downloadurl}})},s.prototype.F=function(){var n=this,t=+new Date-+this.D;return this._&&t<3e5?Promise.resolve(this._):this.r.send(12,{}).then(function(t){return n._=t.token,n.D=new Date,n._})},s}(n);return function(i){function t(t){var n=i.call(this)||this;return n.o="",n.i=new s,n.r=new m(n.i),n.G=new o(n.i,n.r),n.Q=new u(n.i,n.r),n.V=new p(n.i,n.r),n.Y(),n.Z(),n.$(),n.tt(),n.nt(),t&&n.init(t).then(),n}return e(t,i),t.prototype.init=function(t){var n=[];if(this.o=t.appKey,t.userId&&t.token&&n.push(this.login(t.userId+"",t.token,!0).then(function(){})),t.roomId){t.roomId instanceof Array||(t.roomId=[t.roomId]);for(var i=0,r=t.roomId;i<r.length;i++){var e=r[i];n.push(this.joinRoom(e).then(function(){}))}}return t.useMessageType&&this.registerMessageType(t.useMessageType),t.userId&&t.token?Promise.all(n).then(function(){}):Promise.resolve()},t.prototype.uninit=function(){this.logout()},t.prototype.login=function(t,n,i){return void 0===i&&(i=!1),this.G.login(this.o,""+t,n).catch(function(t){if(!i)throw t})},t.prototype.logout=function(){this.Q.clear(),this.V.clear(),this.G.logout()},t.prototype.isLogging=function(){return this.G.isLogging()},t.prototype.isLogged=function(){return this.G.isLogged()},t.prototype.getMyUserId=function(){return this.G.getMyUserId()},t.prototype.joinRoom=function(t){var n=this;return this.G.doIfLogged().then(function(){return n.Q.joinRoom(t)})},t.prototype.leaveRoom=function(t){var n=this;return this.G.doIfLogged().then(function(){return t?n.Q.leaveRoom(t):n.Q.leaveAllRoom()})},t.prototype.inRoom=function(t){return this.Q.inRoom(t)},t.prototype.getRoomIdList=function(){return this.Q.getRoomIdList()},t.prototype.registerMessageType=function(t){if(t instanceof Array)for(var n=0,i=t;n<i.length;n++){var r=i[n];this.V.registerMessageType(r)}else this.V.registerMessageType(t)},t.prototype.sendToRoom=function(t,n,i){var r=this;return void 0===i&&(i=!1),this.G.doIfLogged().then(function(){return r.Q.doIfJoinedRoom(t+"")}).then(function(){return r.V.sendToRoom(t+"",n)}).catch(function(t){if(!i&&(i=!0,!n.isCanceled()))throw t})},t.prototype.sendToUser=function(t,n,i){var r=this;return void 0===i&&(i=!1),this.G.doIfLogged().then(function(){return r.V.sendToUser(t+"",n)}).catch(function(t){if(!i&&(i=!0,!n.isCanceled()))throw t})},t.prototype.requestHistoryMessage=function(t,n,i,r){return this.V.requestHistoryMessage(t,n,i,r)},t.prototype.Y=function(){var t=this;this.r.on("status:reconnecting",function(){return t.G.reconnect().then(function(){return t.Q.reconnect()})})},t.prototype.Z=function(){var i=this;this.G.on("login",function(){return i.emit("account.login")}),this.G.on("logging",function(){return i.emit("account.logging")}),this.G.on("logout",function(){return i.emit("account.logout")}),this.G.on("kickoff",function(){return i.emit("account.kickoff")}),this.G.on("error:*",function(t,n){return i.emit("account."+t,n)})},t.prototype.$=function(){var r=this;this.Q.on("join:*",function(t,n){return r.emit("room.join:"+n,n)}),this.Q.on("joining:*",function(t,n){return r.emit("room.joining:"+n,n)}),this.Q.on("leave:*",function(t,n){return r.emit("room.leave:"+n,n)}),this.Q.on("join-error:*",function(t,n,i){return r.emit("room.join-error:"+n.name,n,i)}),this.Q.on("leave-error:*",function(t,n,i){return r.emit("room.leave-error:"+n.name,n,i)})},t.prototype.tt=function(){var r=this;this.V.on("send:*",function(t,n){return r.emit("message:send:"+n.chatType+":"+n.withPeer,n)}),this.V.on("send-failed:*",function(t,n,i){return r.emit("message:"+t,n,i)}),this.V.on("receive:*",function(t,n){return r.emit("message:receive:"+n.chatType+":"+n.withPeer,n)})},t.prototype.nt=function(){var i=this;this.r.on("status:*",function(t,n){return i.emit("signaling.status:"+n,n)}),this.r.on("ready",function(){return i.emit("signaling.ready")}),this.r.on("message:*",function(t,n){return i.emit("signaling.receive:"+n.base.msgtype,n)}),this.r.on("send:*",function(t,n){return i.emit("signaling.send:"+n.base.msgtype,n)}),this.r.on("error",function(t){return i.emit("signaling.error",t)})},t.Message=y,t.WildEmitter=n,t}(n)});
